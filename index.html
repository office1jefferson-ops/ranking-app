<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RHODENBURG – Übersicht</title>
<meta name="color-scheme" content="dark light">
  <link rel="icon" type="image/png" href="favicon.png">
<style>
  :root{
    --fs-base: 13px;
    --bg:#0b0f17; --bg2:#0f1522; --panel:#0d1423; --panel2:#0e1628;
    --text:#eaf2ff; --muted:#9fb3d9; --line:#22365e;
    --accent:#59a6ff; --accent2:#9ad1ff;
    --gold:#ffcc4d; --silver:#c7d2e1; --bronze:#d7a476; --steel:#7f8aa9;
    --glow: 0 0 22px rgba(89,166,255,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1000px 620px at 70% 8%, #14203a 0%, var(--bg) 55%) fixed;
    color:var(--text);
    font:500 var(--fs-base)/1.35 ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .wrap{ min-height:100dvh; display:grid; gap:14px; padding:14px; grid-template-rows:auto auto 1fr; }

  /* Top */
  .top{ display:grid; gap:8px; align-items:center; grid-template-columns: 1fr auto 1fr; }
  .updated{
    justify-self:start; color:var(--muted); font-size:12px; white-space:nowrap;
    background:linear-gradient(180deg,#0d1423,#0a1120); border:1px solid var(--line); padding:6px 8px; border-radius:10px;
  }
  .brand{ justify-self:center; text-align:center; display:grid; gap:2px; user-select:none; }
  .brand .main{
    font-weight:900; letter-spacing:.055em; font-size:clamp(20px,2.6vw,30px);
    text-transform:uppercase; text-shadow: 0 0 10px rgba(154,209,255,.2);
  }
  .brand .sub{
    color:var(--muted); letter-spacing:.22em; font-weight:700; font-size:clamp(10px,1.3vw,12px);
    text-transform:uppercase; white-space:nowrap;
  }
  .brand .code{
    color:var(--muted); font-size:10px; letter-spacing:.08em; margin-top:2px;
  }
  .selector{
    justify-self:end; display:flex; align-items:center; gap:8px;
    background:linear-gradient(180deg,#0f182a,#0a1120);
    border:1px solid var(--line); border-radius:999px; padding:5px 8px; min-width:230px;
    box-shadow:var(--glow);
  }
  .selector span{color:var(--muted); font-weight:700; letter-spacing:.15px; font-size:12px}
  .selector select{
    appearance:none; border:1px solid var(--line); background:#0e1628; color:#fff;
    padding:6px 8px; border-radius:9px; font-weight:800; min-width:150px; text-align:center; font-size:12px;
  }

  /* Grid */
  .grid{
    display:grid; gap:14px;
    grid-template-columns: 1fr 1fr;
    grid-template-areas:
      "day week"
      "rankD rankW"
      "video video";
  }
  .panel{
    background:linear-gradient(180deg, var(--panel2), var(--panel));
    border:1px solid var(--line); border-radius:16px; box-shadow:var(--glow);
    padding:16px 14px 20px;
    min-width:0;
  }
  .panel h2{ margin:0 0 8px 0; font-size:13px; letter-spacing:.25px; color:var(--muted); text-transform:uppercase; }

  /* Day Challenge */
  .day{ grid-area: day; position:relative; }
  .goalBig{ display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; font-weight:900; letter-spacing:.2px; }
  .goalBig .num{ font-size:clamp(22px,3.3vw,28px); }
  .goalBig .star{ width:20px;height:20px; filter: drop-shadow(0 0 7px rgba(154,209,255,.75)); }
  .badgeLive{
    margin-left:auto; display:inline-flex; align-items:center; gap:6px;
    background:#e33; color:#fff; font-weight:900; padding:4px 8px; border-radius:9px; letter-spacing:.35px; font-size:11px;
    box-shadow:0 0 10px rgba(255,77,109,.45);
  }

  /* Balken exakt zwischen Zahl (links) und LIVE (rechts) */
  .barWrap{ margin-top:14px; margin-bottom:14px; height:10px; position:relative; width:auto; }
  .bar{
    position:relative; height:10px; border-radius:999px; overflow:hidden;
    background:linear-gradient(180deg, #0c1323, #0a1120); border:1px solid var(--line);
    width:100%;
  }
  .bar .fill{
    position:absolute; inset:0; width:0%;
    background:linear-gradient(90deg, rgba(89,166,255,.4), rgba(154,209,255,.95));
    box-shadow:0 0 16px rgba(154,209,255,.5);
    transition: width .7s cubic-bezier(.2,.8,.2,1);
  }

  /* Ticks */
  .ticks{position:relative; height:0; margin-top:6px}
  .tick{position:absolute; top:-5px; width:2px; height:16px; background:#3a5a95; border-radius:2px}
  .tick label{position:absolute; top:16px; transform:translateX(-50%); color:var(--muted); font-size:9px; font-weight:900; white-space:nowrap}

  .pair{ margin-top:6px; color:var(--muted); display:flex; gap:6px; flex-wrap:wrap; font-weight:700; font-size:12px; }
  .pair strong{color:var(--text)}

  /* Week Challenge */
  .week{ grid-area: week; }
  .gauge{ display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:center; }
  .ring{ position:relative; width:160px; aspect-ratio:1 / 1; min-width:160px; }
  .ring svg{ width:100%; height:100%; display:block; transform:rotate(-90deg) }
  .ring .center{ position:absolute; inset:0; display:grid; align-content:center; justify-items:center; gap:2px; text-align:center; }
  .ring .pct{ font-weight:900; font-size:clamp(18px,3.2vw,22px) }
  .ring .sub{ color:var(--muted); font-size:11px }
  .pulse{
    position:absolute; inset:-8px; border-radius:50%; pointer-events:none;
    box-shadow: 0 0 32px rgba(89,166,255,.35), inset 0 0 18px rgba(154,209,255,.18);
    animation: pulse 2.6s ease-in-out infinite;
  }
  .weekPair{
    display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:clamp(18px,3.0vw,24px); gap:10px; flex-wrap:wrap;
  }
  .weekPair .star{ width:18px; height:18px; filter: drop-shadow(0 0 7px rgba(154,209,255,.75)); }
  .slash{ color:var(--muted); font-weight:700 }

  /* Rankings */
  .rankD{ grid-area:rankD; position:relative }
  .rankW{ grid-area:rankW; position:relative }
  .list{
    display:flex; flex-direction:column; gap:8px; margin-top:6px; max-height:42vh; overflow:auto; padding-right:6px
  }
  .row{
    display:grid; grid-template-columns: 38px minmax(0,1fr) auto; align-items:center; gap:8px;
    padding:8px; border:1px solid #23385f; border-radius:10px; background:#0d1423cc; backdrop-filter: blur(4px);
    min-width:0;
  }
  .medal{width:30px;height:30px;border-radius:9px;display:grid;place-items:center;font-weight:900;color:#081018; font-size:13px; box-shadow: inset 0 0 8px rgba(0,0,0,.35)}
  .gold {background:linear-gradient(180deg, #ffe38b, var(--gold)); border:1px solid #9b7c2a}
  .silver{background:linear-gradient(180deg, #e3edf8, var(--silver)); border:1px solid #7a8796}
  .bronze{background:linear-gradient(180deg, #ffd3b0, var(--bronze)); border:1px solid #9a6d42}
  .steel{background:linear-gradient(180deg, #99a6c5, var(--steel)); border:1px solid #586178}
  .name{font-weight:700; min-width:0}
  .stars{display:flex; align-items:center; gap:6px; font-variant-numeric:tabular-nums}
  .sstar{width:14px;height:14px;filter: drop-shadow(0 0 6px rgba(106,182,255,.8))}

  /* Video Panel */
  .video{ grid-area:video; }
  .panelHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .videoToggle{
    background:linear-gradient(180deg,#123361,#0b2244);
    color:#cfe3ff; border:1px solid #28508a; padding:6px 10px;
    border-radius:9px; font-weight:800; cursor:pointer;
  }
  .videoBody{ display:none; margin-top:14px; }
  .videoWrap{
    position:relative; padding-top:56.25%; border-radius:16px; overflow:hidden;
    box-shadow:var(--glow); border:1px solid var(--line);
  }
  .videoWrap iframe{ position:absolute; top:0; left:0; width:100%; height:100%; }

  /* Mehrere Video-Blöcke */
  .videoBlock{ display:grid; gap:8px; margin-top:14px; }
  .videoBlock h3{ margin:0; font-size:12px; color:var(--muted); letter-spacing:.2px; text-transform:uppercase; }
  .videoGrid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  @media (max-width: 900px){ .videoGrid{ grid-template-columns:1fr; } }

  /* Schloss / Modals */
  .lockOverlay{
    position:absolute; inset:0;
    background:#0b0f17; border:none; border-radius:16px;
    display:grid; place-items:center; z-index:4;
  }
  .lockIcon{ display:grid; place-items:center; gap:6px; text-align:center; opacity:.9; user-select:none; }
  .lockIcon svg{ width:40px; height:40px; display:block; filter: drop-shadow(0 0 8px rgba(154,209,255,.22)); }
  .lockIcon small{ color:var(--muted); letter-spacing:.15px; font-weight:800; text-transform:uppercase; font-size:10px }

  .rankLockModal{
    position:fixed; inset:0; display:none; place-items:center;
    background:linear-gradient(180deg, rgba(7,11,20,.86), rgba(7,11,20,.86));
    z-index:999;
  }
  .lockCard{
    background:#0e1628; border:1px solid var(--line); border-radius:12px; padding:14px; min-width:260px;
    display:grid; gap:8px; text-align:center; box-shadow:var(--glow);
  }
  .lockCard h3{ margin:0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.2px }
  .lockCard input{
    background:#0b1324; color:#fff; border:1px solid var(--line); border-radius:9px; padding:8px; text-align:center; font-weight:800;
  }
  .lockCard button{
    background:linear-gradient(180deg,#123361,#0b2244); color:#cfe3ff; border:1px solid #28508a;
    padding:8px 10px; border-radius:9px; font-weight:900; cursor:pointer;
  }

  /* Page gate */
  .pageGate{
    position:fixed; inset:0; display:grid; place-items:center; background:radial-gradient(1200px 800px at 50% 15%, #111c33, #070b14 60%);
    z-index:9999;
  }

  /* Responsive */
  @media (max-width: 900px){
    .grid{ grid-template-columns: 1fr; grid-template-areas: "day" "week" "rankD" "rankW" "video"; }
    .list{ max-height:40vh }
    .selector,.updated{ justify-self:center }
  }
</style>
</head>
<body>
<!-- Page-wide password gate -->
<div class="pageGate" id="pageGate">
  <div class="lockCard" style="display:grid">
    <h3>Zugriff geschützt</h3>
    <input type="password" id="sitePwd" placeholder="Passwort" autocomplete="current-password"/>
    <button id="siteBtn">Anmelden</button>
    <div style="color:var(--muted); font-size:12px">Bleibt 24h auf diesem Gerät angemeldet.</div>
  </div>
</div>

<!-- Gemeinsames Ranking-Passwort-Modal -->
<div class="rankLockModal" id="rankLockModal" aria-hidden="true">
  <div class="lockCard" role="dialog" aria-modal="true">
    <h3>Ranking geschützt</h3>
    <input type="password" id="rankPwd" placeholder="Passwort"/>
    <button id="rankBtn">Entsperren</button>
  </div>
</div>

<div class="wrap" aria-hidden="true" id="appRoot">
  <div class="top">
    <div class="updated" id="updatedAt">Aktualisiert: –</div>

    <div class="brand">
      <div class="main">RHODENBURG</div>
      <div class="sub">AKTIENGESELLSCHAFT</div>
      <div class="code">Test.Version3.01.02/4823950</div>
    </div>

    <label class="selector">
      <span>Challenge</span>
      <select id="challengeSelect"></select>
    </label>
  </div>

  <div class="grid">
    <!-- TAGES-CHALLENGE -->
    <section class="panel day" id="dayPanel">
      <h2>TAGES-CHALLENGE</h2>
      <div class="goalBig" id="goalBig">
        <span class="num truncate" id="dayGoalBig">0,00</span>
        <img class="star" alt="★" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='%239ad1ff' viewBox='0 0 24 24'><path d='M12 2l2.9 6.6 7.1.6-5.4 4.7 1.6 7-6.2-3.8-6.2 3.8 1.6-7L2 9.2l7.1-.6z'/></svg>">
        <span class="badgeLive" id="badgeLive">LIVE</span>
      </div>

      <div class="barWrap" id="barWrap">
        <div class="bar"><div class="fill" id="dayFill"></div></div>
        <div class="ticks" id="dayTicks"></div>
      </div>

      <div class="pair"><span>Heute:</span>
        <strong id="dayIstPair">0</strong>
        <img class="sstar" alt="★" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%2359a6ff' viewBox='0 0 24 24'><path d='M12 2l2.9 6.6 7.1.6-5.4 4.7 1.6 7-6.2-3.8-6.2 3.8 1.6-7L2 9.2l7.1-.6z'/></svg>">
        <span>/</span>
        <strong id="dayGoalPair">0</strong>
        <img class="sstar" alt="★" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%239ad1ff' viewBox='0 0 24 24'><path d='M12 2l2.9 6.6 7.1.6-5.4 4.7 1.6 7-6.2-3.8-6.2 3.8 1.6-7L2 9.2l7.1-.6z'/></svg>">
      </div>
    </section>

    <!-- WOCHEN-CHALLENGE -->
    <section class="panel week">
      <h2>WOCHEN-CHALLENGE</h2>
      <div class="gauge">
        <div class="ring">
          <svg viewBox="0 0 120 120" aria-hidden="true">
            <defs>
              <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#59a6ff"/><stop offset="100%" stop-color="#9ad1ff"/>
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="52" stroke="#1a2a4b" stroke-width="12" fill="none"/>
            <circle id="ringProgress" cx="60" cy="60" r="52" stroke="url(#rg)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="326.73"/>
          </svg>
          <div class="center">
            <div class="pct" id="weekPct">0,00%</div>
            <div class="sub">Fortschritt</div>
          </div>
          <div class="pulse" aria-hidden="true"></div>
        </div>

        <div class="weekPair">
          <span id="weekIstBig">0,00</span>
          <img class="star" alt="★" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='%2359a6ff' viewBox='0 0 24 24'><path d='M12 2l2.9 6.6 7.1.6-5.4 4.7 1.6 7-6.2-3.8-6.2 3.8 1.6-7L2 9.2l7.1-.6z'/></svg>">
          <span class="slash">/</span>
          <span id="weekGoalBig">0,00</span>
          <img class="star" alt="★" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='%239ad1ff' viewBox='0 0 24 24'><path d='M12 2l2.9 6.6 7.1.6-5.4 4.7 1.6 7-6.2-3.8-6.2 3.8 1.6-7L2 9.2l7.1-.6z'/></svg>">
        </div>
      </div>
    </section>

    <!-- RANKINGS -->
    <section class="panel rankD" id="rankDPanel">
      <h2>Tagesranking</h2>
      <div class="list" id="dayList"></div>
      <div class="lockOverlay" id="lockRankDay">
        <div class="lockIcon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="#9ad1ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3.5" y="11" width="17" height="10" rx="2" ry="2"></rect>
            <path d="M7 11V8a5 5 0 0 1 10 0v3"></path>
            <circle cx="12" cy="16" r="1.8" fill="#59a6ff" stroke="none"></circle>
          </svg>
          <small>Gesperrt</small>
        </div>
      </div>
    </section>

    <section class="panel rankW" id="rankWPanel">
      <h2>Wochenranking</h2>
      <div class="list" id="weekList"></div>
      <div class="lockOverlay" id="lockRankWeek">
        <div class="lockIcon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="#9ad1ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3.5" y="11" width="17" height="10" rx="2" ry="2"></rect>
            <path d="M7 11V8a5 5 0 0 1 10 0v3"></path>
            <circle cx="12" cy="16" r="1.8" fill="#59a6ff" stroke="none"></circle>
          </svg>
          <small>Gesperrt</small>
        </div>
      </div>
    </section>

    <!-- VIDEOS (jetzt 5 Abschnitte: oben "Aktuell" mit 2 Videos) -->
    <section class="panel video" id="videoPanel">
      <div class="panelHeader">
        <h2>Videos</h2>
        <button class="videoToggle" id="videoToggleBtn">Videos ausklappen</button>
      </div>
      <div class="videoBody" id="videoPanelBody">
        <!-- Aktuell: 2 Videos nebeneinander -->
        <div class="videoBlock">
          <h3>Aktuell</h3>
          <div class="videoGrid">
            <div class="videoWrap">
              <iframe 
                src="https://player.vimeo.com/video/1131998437?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479"
                frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen>
              </iframe>
            </div>
            <div class="videoWrap">
              <iframe 
                src="https://player.vimeo.com/video/1132003260?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479"
                frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen>
              </iframe>
            </div>
          </div>
        </div>

        <!-- My Easy Job -->
        <div class="videoBlock">
          <h3>My Easy Job</h3>
          <div class="videoWrap">
            <iframe 
              src="https://player.vimeo.com/video/1130609207?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479"
              frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen>
            </iframe>
          </div>
        </div>

        <!-- Money Prime -->
        <div class="videoBlock">
          <h3>Money Prime</h3>
          <div class="videoWrap">
            <iframe 
              src="https://player.vimeo.com/video/1130609482?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479"
              frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen>
            </iframe>
          </div>
        </div>

        <!-- RB Aktiengesellschaft Trailer -->
        <div class="videoBlock">
          <h3>RB Aktiengesellschaft Trailer</h3>
          <div class="videoWrap">
            <iframe 
              src="https://player.vimeo.com/video/1131985527?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479"
              frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen>
            </iframe>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbwyJwq3p9xeht_2gZfbYfo78pI-VASmv8gdBeTRrUqfa4ClRUTBdCqlAhacaNbEnZ3X2Q/exec";
const POLL_MS = 20000;
const SITE_PWD = "Rhodenburg";
const RANK_PWD = "Rhodenburg1234";
const DAY_MS = 24*60*60*1000;

/* ===== HELPERS ===== */
const fmtDE = (n, f=2)=> new Intl.NumberFormat("de-DE",{minimumFractionDigits:f,maximumFractionDigits:f}).format(Number(n||0));
const fmtInt = n => new Intl.NumberFormat("de-DE",{maximumFractionDigits:0}).format(Number(n||0));

/* Deutsche Zahlen robust parsen und mit 2 Nachkommastellen formatieren */
function parseDE(n){
  if (n == null) return 0;
  if (typeof n === "number") return n;
  const s = String(n).trim().replace(/\./g, "").replace(",", ".");
  const v = parseFloat(s);
  return isNaN(v) ? 0 : v;
}
function fmtDE2(n){
  return new Intl.NumberFormat("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })
    .format(parseDE(n));
}

function tween(el, to, fmt="num", dur=600){
  const from = Number(el._v || 0); const diff = to - from; const t0 = performance.now();
  function frame(t){ const p = Math.min(1,(t-t0)/dur); const e = 1-Math.pow(1-p,3); const v = from + diff*e;
    if(fmt==="int") el.textContent = fmtInt(v);
    else if(fmt==="pct") el.textContent = fmtDE(v) + "%";
    else el.textContent = fmtDE(v);
    el._v = v; if(p<1) requestAnimationFrame(frame);
  } requestAnimationFrame(frame);
}

function buildList(el, items){
  el.innerHTML = "";
  const star16 = "data:image/svg+xml;utf8,"+
    "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='14' height='14' fill='%2359a6ff'><path d='M12 2l2.9 6.6 7.1.6-5.4 4.7 1.6 7-6.2-3.8-6.2 3.8 1.6-7L2 9.2l7.1-.6z'/></svg>";
  (items||[]).forEach((it,i)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="medal ${i===0?"gold":i===1?"silver":i===2?"bronze":"steel"}">${i+1}</div>
      <div class="name truncate">${it.name}</div>
      <div class="stars"><strong>${fmtDE2(it.stars)}</strong> <img class="sstar" alt="★" src="${star16}"></div>`;
    el.appendChild(row);
  });
}

/* Ticks */
function buildDayTicks(){
  const ticksEl = document.getElementById("dayTicks"); ticksEl.innerHTML = "";
  [25,50,75,100].forEach(p=>{
    const d = document.createElement("div"); d.className="tick"; d.style.left = p+"%";
    d.innerHTML = `<label>${p}%</label>`;
    ticksEl.appendChild(d);
  });
}

/* Week ring animation */
function ringTo(circle, pct, dur=800){
  const C = 2*Math.PI*52;
  const from = Number(circle._pct || 0); const to = Math.max(0, Math.min(100, pct));
  const t0 = performance.now();
  function f(t){ const p = Math.min(1,(t-t0)/dur); const e = 1-Math.pow(1-p,3); const v = from + (to-from)*e;
    const off = C * (1 - v/100); circle.style.strokeDashoffset = off; circle._pct = v; if(p<1) requestAnimationFrame(f);
  } requestAnimationFrame(f);
}

/* Tages-Balken exakt spannen und mittig ausrichten */
function alignDayBar(){
  const day = document.getElementById('dayPanel');
  const num = document.getElementById('dayGoalBig');
  const live = document.getElementById('badgeLive');
  const barWrap = document.getElementById('barWrap');
  if(!day || !num || !live || !barWrap) return;

  const rDay  = day.getBoundingClientRect();
  const rNum  = num.getBoundingClientRect();
  const rLive = live.getBoundingClientRect();

  const leftInset  = Math.max(0, rNum.left  - rDay.left);
  const rightInset = Math.max(0, rDay.right - rLive.right);

  barWrap.style.marginLeft  = leftInset + 'px';
  barWrap.style.marginRight = rightInset + 'px';
  barWrap.style.width = 'auto';
}

/* ===== STATE/DATA ===== */
window.state = { data:null, idx:0 };

async function fetchData(){
  const r = await fetch(API_URL, { cache:"no-store" });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

function applyChallenge(ch){
  const dGoal = Number(ch?.day?.ziel || 0);
  const dIst  = Number(ch?.day?.ist  || 0);
  const wGoal = Number(ch?.week?.ziel || 0);
  const wIst  = Number(ch?.week?.ist  || 0);
  const wPct  = Number(ch?.week?.progressPct || (wGoal>0? (wIst/wGoal)*100:0));
  const dPct  = Number(ch?.day?.progressPct  || (dGoal>0? (dIst/dGoal)*100:0));

  // Day
  tween(document.getElementById("dayGoalBig"), dGoal, "num");
  document.getElementById("dayIstPair").textContent  = fmtInt(dIst);
  document.getElementById("dayGoalPair").textContent = fmtInt(dGoal);
  document.getElementById("dayFill").style.width = Math.max(0, Math.min(100, dPct)) + "%";
  buildDayTicks();
  alignDayBar();

  // Week
  ringTo(document.getElementById("ringProgress"), wPct);
  tween(document.getElementById("weekPct"), wPct, "pct");
  document.getElementById("weekIstBig").textContent  = fmtDE(wIst);
  document.getElementById("weekGoalBig").textContent = fmtDE(wGoal);
}

function updateUI(payload){
  window.state.data = payload;
  document.getElementById("updatedAt").textContent =
    "Aktualisiert: " + new Date(payload.updatedAt || Date.now()).toLocaleString("de-DE");

  const sel = document.getElementById("challengeSelect");
  sel.innerHTML = "";
  (payload.challenges||[]).forEach((c,i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = c.title || ("Challenge "+(i+1));
    sel.appendChild(opt);
  });
  if ((payload.challenges||[]).length){
    if (window.state.idx >= payload.challenges.length) window.state.idx = 0;
    sel.value = String(window.state.idx);
    applyChallenge(payload.challenges[window.state.idx]);
  }

  buildList(document.getElementById("dayList"),  payload.day  || []);
  buildList(document.getElementById("weekList"), payload.week || []);
  alignDayBar();
}

/* ===== AUTH (Page) ===== */
function saveWithTTL(key, val, ttlMs){ localStorage.setItem(key, JSON.stringify({v:val, t:Date.now(), ttl:ttlMs})); }
function loadWithTTL(key){
  const raw = localStorage.getItem(key); if(!raw) return null;
  try{ const o = JSON.parse(raw); if(Date.now()-o.t > (o.ttl||0)) { localStorage.removeItem(key); return null; } return o.v; }
  catch(_){ localStorage.removeItem(key); return null; }
}
(function pageAuth(){
  const gate = document.getElementById("pageGate");
  const app  = document.getElementById("appRoot");
  function unlock(){ gate.style.display="none"; app.removeAttribute("aria-hidden"); }
  const ok = loadWithTTL("rhodenburg_site", DAY_MS);
  if(ok === true){ unlock(); return; }
  document.getElementById("siteBtn").addEventListener("click", ()=>{
    const v = (document.getElementById("sitePwd").value||"").trim();
    if(v === SITE_PWD){ saveWithTTL("rhodenburg_site", true, DAY_MS); unlock(); init(); }
    else alert("Falsches Passwort.");
  });
})();

/* ===== AUTH (Rankings) – gemeinsames Modal ===== */
function showRankModal(){
  const m = document.getElementById('rankLockModal');
  m.style.display = 'grid';
  const inp = document.getElementById('rankPwd');
  inp.value = '';
  setTimeout(()=>inp.focus(), 0);
}
function hideRankModal(){
  document.getElementById('rankLockModal').style.display = 'none';
}
function unlockRankings(){
  document.getElementById('lockRankDay').style.display = 'none';
  document.getElementById('lockRankWeek').style.display = 'none';
  hideRankModal();
}
(function rankAuthInit(){
  const saved = loadWithTTL("rhodenburg_rank", DAY_MS);
  const dayOv = document.getElementById("lockRankDay");
  const weekOv = document.getElementById("lockRankWeek");
  const btn = document.getElementById("rankBtn");
  const inp = document.getElementById("rankPwd");
  const modal = document.getElementById("rankLockModal");

  function clickHandler(){
    if(dayOv.style.display !== "none" || weekOv.style.display !== "none"){
      showRankModal();
    }
  }
  dayOv.addEventListener('click', clickHandler);
  weekOv.addEventListener('click', clickHandler);

  btn.addEventListener("click", ()=>{
    if((inp.value||"").trim() === RANK_PWD){ saveWithTTL("rhodenburg_rank", true, DAY_MS); unlockRankings(); }
    else alert("Falsches Passwort.");
  });
  inp.addEventListener("keydown", e=>{ if(e.key==="Enter") btn.click(); });
  modal.addEventListener("click", (e)=>{ if(e.target === modal) hideRankModal(); });

  if(saved === true) unlockRankings();
})();

/* ===== Video Toggle (Start: versteckt) ===== */
(function initVideoToggle(){
  const btn = document.getElementById('videoToggleBtn');
  const body = document.getElementById('videoPanelBody');
  function setVisible(v){
    body.style.display = v ? 'block' : 'none';
    btn.textContent = v ? 'Videos einklappen' : 'Videos ausklappen';
  }
  setVisible(false); // Startzustand: ausgeblendet
  btn.addEventListener('click', ()=> setVisible(body.style.display === 'none'));
})();

/* ===== INIT ===== */
function init(){
  const sel = document.getElementById("challengeSelect");
  sel.addEventListener("change", (e)=>{
    window.state.idx = Number(e.target.value||0);
    if (window.state.data?.challenges) applyChallenge(window.state.data.challenges[window.state.idx]);
  });

  // Erstes Rendering
  updateUI({updatedAt:Date.now(), day:[], week:[], challenges:[]});

  // Live-Daten
  fetchData().then(d=>{ window.state.data=d; updateUI(d); }).catch(console.error);
  setInterval(async()=>{
    try{
      const d = await fetchData();
      window.state.data = d;
      updateUI(d);
    }catch(e){}
  }, POLL_MS);

  // Re-Align on resize
  window.addEventListener('resize', alignDayBar);
}

// Falls Page-Auth bereits aktiv war
if(localStorage.getItem("rhodenburg_site")) {
  const ok = loadWithTTL("rhodenburg_site", DAY_MS);
  if(ok===true){
    document.getElementById("pageGate").style.display="none";
    document.getElementById("appRoot").removeAttribute("aria-hidden");
    init();
  }
}
</script>
</body>
</html>
