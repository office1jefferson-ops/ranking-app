<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>Ranking</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    body{
      margin:0;background:radial-gradient(circle at top,#0a0f1e,#000);color:#fff;
      font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;display:flex;justify-content:center;align-items:center;
    }
    .container{display:flex;flex-direction:column;gap:30px;width:95%;max-width:600px;text-align:center;}
    .block{background:rgba(20,25,40,.95);border-radius:16px;padding:15px;box-shadow:0 0 15px rgba(0,0,0,.6);position:relative;overflow:hidden}
    .block.tag{border:2px solid #3af;box-shadow:0 0 15px #3af,0 0 30px #08f inset}
    .block h2{margin:0 0 10px;font-size:1.4rem;letter-spacing:1px;text-transform:uppercase;text-shadow:0 0 8px rgba(255,255,255,.5)}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    td{padding:6px 8px;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative}
    td.rank{width:40px;font-weight:700;text-align:center;position:relative;overflow:visible} /* wichtig: Krone nicht clippen */
    td.je{text-align:right;font-variant-numeric:tabular-nums}
    .gold{color:gold}.silver{color:silver}.bronze{color:#cd7f32}

    /* Krone sitzt sichtbar auf der â€ž1â€œ (leicht schrÃ¤g) */
    .crown{
      position:absolute;
      top:2px;                      /* tiefer = nicht abgeschnitten */
      left:50%;
      transform:translate(-50%,-35%) rotate(-18deg);
      transform-origin:bottom center;
      font-size:1.1rem;
      text-shadow:0 0 6px gold,0 0 12px orange;
      pointer-events:none;
      z-index:2;                    /* Ã¼ber der Zahl */
    }

    .error{opacity:.8;font-size:.9rem;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="block tag">
      <h2>Tag</h2>
      <table id="tag"></table>
      <div class="error" id="err-tag"></div>
    </div>
    <div class="block">
      <h2>Woche</h2>
      <table id="woche"></table>
      <div class="error" id="err-woche"></div>
    </div>
    <div class="block">
      <h2>Monat</h2>
      <table id="monat"></table>
      <div class="error" id="err-monat"></div>
    </div>
    <div class="block">
      <h2>Jahr</h2>
      <table id="jahr"></table>
      <div class="error" id="err-jahr"></div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx0gxZelxsLaQJnA1nLfyp9k_PiAlptZsPsRrsVDGRwS_yHjCMsDM1ZKA3GBEwdCYi9/exec";

    // Merker fÃ¼r Tag Platz 1 (Name) â†’ nur bei Wechsel animieren
    let prevDayTopName = null;

    function formatJEFromAPI(v){
      const num = parseFloat(String(v).replace(",", "."));
      if (isNaN(num)) return "";
      return num.toLocaleString("de-DE", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + " JE";
    }

    async function loadData(){
      try{
        const res = await fetch(API_URL + "?_ts=" + Date.now(), {cache:"no-store"});
        const data = await res.json();
        renderBlock("tag",   data.day,   "err-tag",   true);
        renderBlock("woche", data.week,  "err-woche");
        renderBlock("monat", data.month, "err-monat");
        renderBlock("jahr",  data.year,  "err-jahr");
      }catch(e){
        console.error(e);
        showErr("err-tag","API nicht erreichbar");
        showErr("err-woche","");
        showErr("err-monat","");
        showErr("err-jahr","");
      }
    }

    function showErr(errId,msg){
      const el = document.getElementById(errId);
      if(!el) return;
      el.textContent = msg || "";
    }

    function renderBlock(tableId, arr, errId, isDay=false){
      const table = document.getElementById(tableId);
      if(!table) return;

      table.innerHTML = "";
      showErr(errId,"");

      const items = Array.isArray(arr) ? arr.slice(0,5) : [];
      if(items.length === 0){ showErr(errId,"Keine Daten"); }

      items.forEach((row, i) => {
        const tr = document.createElement("tr");

        const tdRank = document.createElement("td");
        tdRank.className = "rank";
        tdRank.textContent = (i+1);
        if(i===0) tdRank.classList.add("gold");
        else if(i===1) tdRank.classList.add("silver");
        else if(i===2) tdRank.classList.add("bronze");

        const tdName = document.createElement("td");
        tdName.textContent = row?.name ?? "";

        const tdJE = document.createElement("td");
        tdJE.className = "je";
        tdJE.textContent = formatJEFromAPI(row?.je);

        tr.appendChild(tdRank);
        tr.appendChild(tdName);
        tr.appendChild(tdJE);
        table.appendChild(tr);
      });

      // Einblenden des Blocks
      gsap.fromTo(table,{opacity:0,y:10},{opacity:1,y:0,duration:.8,ease:"power2.out"});

      // Krone nur im Tag-Block
      if(isDay){
        const topName = items?.[0]?.name || null;
        const rankCell = table.querySelector("tr:first-child td.rank");
        if(rankCell){
          const crown = ensureCrown(rankCell);

          if(prevDayTopName === null){
            // Erstes Rendering â†’ keine Animation
            gsap.set(crown, {opacity:1, y:0, rotate:-18});
          }else if(topName !== prevDayTopName){
            // Neuer Platz 1 â†’ Krone fliegt/landet auf die â€ž1â€œ
            gsap.fromTo(crown,
              {y:-40, opacity:0, rotate:-40},
              {y:0, opacity:1, rotate:-18, duration:0.9, ease:"bounce.out"}
            );
          }else{
            // Kein Wechsel â†’ Krone ruhig
            gsap.set(crown, {opacity:1, y:0, rotate:-18});
          }
        }
        prevDayTopName = topName;
      }
    }

    // Krone in die Rank-Zelle setzen (falls nicht vorhanden)
    function ensureCrown(rankCell){
      let crown = rankCell.querySelector(".crown");
      if(!crown){
        crown = document.createElement("span");
        crown.className = "crown";
        crown.textContent = "ðŸ‘‘";
        rankCell.appendChild(crown);
      }
      return crown;
    }

    loadData();
    setInterval(loadData, 15000); // Auto-Refresh
  </script>
</body>
</html>
