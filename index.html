<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Rhodenburg AG â€“ Ãœbersicht & Dashboard</title>
<style>
:root{
  --bg:#060a12; --panel:#0b1324; --panel2:#0e1628; --line:#1d2b46; --text:#cfe3ff; --muted:#8fa8d4;
  --accent:#3ea6ff; --accent2:#2ad0ff; --gold:#f6c65b; --silver:#cfd8e6; --bronze:#c7935a;
  --good:#2ad37f; --warn:#ffcc66; --danger:#ff6b6b; --glow:0 0 28px rgba(62,166,255,.18);
  --scale:.8; /* ~20% kleiner */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1400px 900px at 20% -10%, #0b1425, #060a12 70%);
  color:var(--text); font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  transform-origin: top center; transform: scale(var(--scale));
}
.app{
  max-width:1200px; margin:24px auto 64px; padding:0 20px; position:relative;
}
.header{
  display:grid; grid-template-columns:1fr auto 1fr; align-items:center; column-gap:16px; margin-bottom:16px;
}
.brand{
  display:grid; justify-items:center; gap:2px;
}
.brand .title{
  font-weight:1000; letter-spacing:.12em; font-size:36px; line-height:1; text-transform:uppercase;
}
.brand .subtitle{
  font-weight:800; letter-spacing:.28em; /* enger als zuvor */ font-size:11px; color:var(--muted);
  text-transform:uppercase; transform: translateY(-1px);
}
.brand .tiny{
  font-size:10px; color:var(--muted); margin-top:4px; letter-spacing:.04em;
}
.rightTop{
  display:flex; align-items:center; gap:8px; justify-content:flex-end;
}
.kv{
  background:linear-gradient(180deg,#0b1324,#0a1222); border:1px solid var(--line); box-shadow:var(--glow);
  padding:8px 10px; border-radius:12px; display:flex; gap:10px; align-items:center;
}
.kv b{font-size:12px; color:#9fb3d9;}
select{
  background:#0b1324; border:1px solid var(--line); color:var(--text);
  padding:8px 10px; border-radius:10px; font-weight:700;
}
.updated{ color:var(--muted); font-size:12px }

.grid{
  display:grid; grid-template-columns:repeat(12,1fr); gap:16px; align-items:stretch;
}
.panel{
  background:linear-gradient(180deg, var(--panel), var(--panel2));
  border:1px solid var(--line); border-radius:16px; padding:14px; box-shadow:var(--glow); position:relative; overflow:hidden;
}
.panel h2{
  margin:0 0 10px; font-size:14px; letter-spacing:.12em; text-transform:uppercase; color:#9fb3d9;
}

/* Tages-Challenge */
.dayBox{ grid-column:1/13; }
.meterWrap{
  display:grid; gap:10px; margin-top:10px; padding:10px 10px 14px; /* tiefer gelegt */
  background:linear-gradient(180deg,#0a1221,#0e1628); border:1px solid #14203a; border-radius:12px;
}
.milestones{
  display:flex; justify-content:space-between; position:relative; height:28px; /* etwas mehr Luft */
}
.milestones .mark{
  position:relative; width:0; height:100%;
}
.milestones .label{
  position:absolute; top:-10px; transform:translateX(-50%); font-size:10px; color:#9fb3d9; white-space:nowrap;
}
.milestones .label.hundred{ transform:translateX(calc(-50% - 6px)); } /* 100% leicht nach links */
.progressBar{
  height:12px; border-radius:999px; background:#0a1330; border:1px solid #1a2b56; position:relative; overflow:hidden;
}
.progressBar .liveTag{
  position:absolute; left:8px; top:50%; transform:translateY(-50%); font-size:10px; color:#7fb7ff; font-weight:800; letter-spacing:.1em;
}
.progressBar .fill{
  position:absolute; inset:0; width:0%;
  background:linear-gradient(90deg,#2a86ff 0%, #2ad0ff 40%, #7cf9ff 100%);
  box-shadow:0 0 20px rgba(46,180,255,.35) inset, 0 0 14px rgba(46,180,255,.45);
  border-radius:999px;
  transition:width .6s cubic-bezier(.22,.8,.2,1);
}
.smallNote{
  font-size:12px; color:#9fb3d9; display:flex; gap:8px; align-items:center; justify-content:flex-end;
}

/* Wochen-Challenge */
.weekBox{ grid-column:1/13; }
.weekWrap{ display:grid; grid-template-columns:220px 1fr; gap:16px; align-items:center; }
.radial{
  width:220px; height:220px; border-radius:50%;
  background:radial-gradient(120px 120px at 50% 45%, #152544, #0e1628 80%);
  display:grid; place-items:center; position:relative;
  border:1px solid #1a2b56; box-shadow:var(--glow);
}
.radial svg{ width:170px; height:170px; display:block; }
.radial .center{
  position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; text-align:center;
}
.radial .pct{ font-size:22px; font-weight:1000; letter-spacing:.04em; }
.radial .cap{ font-size:11px; color:#9fb3d9; margin-top:2px; }
.weekRight{
  display:flex; align-items:center; justify-content:center; height:100%;
  font-size:32px; font-weight:1000; letter-spacing:.02em;
}
.weekRight .big{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
.star{ width:18px; height:18px; display:inline-block; transform:translateY(2px); }
.star svg{ width:100%; height:100%; filter: drop-shadow(0 0 6px rgba(80,200,255,.5)); }

/* Rankings nebeneinander */
.rankRow{ grid-column:1/13; display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.rankD,.rankW{ min-height:300px; }
.list{ display:grid; gap:10px }
.item{
  display:grid; grid-template-columns:44px 1fr auto; gap:10px; align-items:center;
  padding:10px; border:1px solid #122242; border-radius:12px;
  background:linear-gradient(180deg,#0b1324,#0c1528);
}
.rankNum{ font-size:16px; font-weight:1000; text-align:center; }
.name{ font-weight:900; letter-spacing:.02em }
.score{ font-weight:1000; display:flex; align-items:center; gap:8px; font-size:14px }
.badge{ width:28px; height:28px; border-radius:50% }
.badge.gold{ background:radial-gradient(14px 14px at 40% 35%, #ffeaa6, #f6c65b); box-shadow:0 0 14px rgba(246,198,91,.35) }
.badge.silver{ background:radial-gradient(14px 14px at 40% 35%, #ffffff, #cfd8e6); box-shadow:0 0 14px rgba(207,216,230,.35) }
.badge.bronze{ background:radial-gradient(14px 14px at 40% 35%, #ffd7b0, #c7935a); box-shadow:0 0 14px rgba(199,147,90,.35) }

/* Click-to-unlock Cover (Ranking) */
.tapCover{
  position:absolute; inset:0; display:grid; place-items:center;
  background:linear-gradient(180deg, rgba(9,13,22,.78), rgba(9,13,22,.86));
  border:1px dashed #39507c; border-radius:16px; z-index:4; cursor:pointer;
  color:#cfe3ff; font-weight:800; letter-spacing:.2px; text-align:center; padding:16px;
}
.tapCover span{ opacity:.85; font-size:13px }
.tapCover .hint{ color:#9fb3d9; font-weight:600; font-size:12px; margin-top:6px }

/* Modals (Site + Ranking) */
.modalBackdrop{
  position:fixed; inset:0; display:none; place-items:center; z-index:10000;
  background:radial-gradient(900px 600px at 50% 25%, rgba(17,28,51,.92), rgba(7,11,20,.94));
}
.modal{ background:#0e1628; border:1px solid var(--line); border-radius:12px; padding:16px;
  width:min(92vw, 360px); box-shadow:var(--glow); display:grid; gap:10px; text-align:center;
}
.modal h3{ margin:0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.2px }
.modal input{
  background:#0b1324; color:var(--text); border:1px solid var(--line);
  border-radius:9px; padding:10px; text-align:center; font-weight:800;
}
.modal .rowBtns{ display:flex; gap:8px; justify-content:center }
.modal button{
  background:linear-gradient(180deg,#123361,#0b2244); color:#cfe3ff; border:1px solid #28508a;
  padding:9px 12px; border-radius:9px; font-weight:900; cursor:pointer; min-width:110px;
}

/* helper */
.row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
.label{ font-size:12px; color:#9fb3d9; letter-spacing:.12em; text-transform:uppercase; font-weight:900 }
.val{ font-weight:1000; }
.liveChip{ color:#7cf9ff; font-weight:900; letter-spacing:.18em; font-size:11px }
hr.sep{ border:none; border-top:1px solid #14203a; margin:8px 0 }
</style>
</head>
<body>
<div class="app" id="app">

  <div class="header">
    <div class="updated">Aktualisiert: <span id="updatedAt">â€“</span></div>

    <div class="brand">
      <div class="title">RHODENBURG</div>
      <div class="subtitle">AKTIENGESELLSCHAFT</div>
      <div class="tiny">Test.va.3248Z3.01</div>
    </div>

    <div class="rightTop">
      <div class="kv">
        <b>Challenge</b>
        <select id="challengeSelect"></select>
      </div>
    </div>
  </div>

  <div class="grid">

    <!-- Tages-Challenge -->
    <section class="panel dayBox">
      <h2>Tages-Challenge</h2>
      <div class="row">
        <div class="label">Ziel</div>
        <div class="val" id="dayGoal">â€“</div>
        <span class="star" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 2l2.7 5.7 6.3.9-4.6 4.5 1.1 6.4-5.6-3-5.6 3 1.1-6.4L3 8.6l6.3-.9L12 2z" fill="#6dd3ff"/></svg>
        </span>
      </div>

      <div class="meterWrap">
        <div class="milestones" id="dayMilestones">
          <!-- 25/50/75/100 (ohne 0) -->
          <div class="mark" style="left:25%"><div class="label">25%</div></div>
          <div class="mark" style="left:50%"><div class="label">50%</div></div>
          <div class="mark" style="left:75%"><div class="label">75%</div></div>
          <div class="mark" style="left:100%"><div class="label hundred">100%</div></div>
        </div>
        <div class="progressBar">
          <div class="liveTag">LIVE</div>
          <div class="fill" id="dayFill" style="width:0%"></div>
        </div>
      </div>

      <div class="smallNote">
        <span id="dayIst">0</span>
        <span class="star" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 2l2.7 5.7 6.3.9-4.6 4.5 1.1 6.4-5.6-3-5.6 3 1.1-6.4L3 8.6l6.3-.9L12 2z" fill="#6dd3ff"/></svg>
        </span>
        /
        <span id="dayZiel">0</span>
        <span class="star" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 2l2.7 5.7 6.3.9-4.6 4.5 1.1 6.4-5.6-3-5.6 3 1.1-6.4L3 8.6l6.3-.9L12 2z" fill="#6dd3ff"/></svg>
        </span>
      </div>
    </section>

    <!-- Wochen-Challenge -->
    <section class="panel weekBox">
      <h2>Wochen-Challenge</h2>
      <div class="weekWrap">
        <div class="radial">
          <!-- sauberer Kreis (quadratisches viewBox) -->
          <svg viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="42" stroke="#132447" stroke-width="10" fill="none"/>
            <circle id="weekArc" cx="50" cy="50" r="42" stroke="url(#grad)" stroke-width="10" fill="none"
                    stroke-linecap="round" transform="rotate(-90 50 50)" stroke-dasharray="264" stroke-dashoffset="264"/>
            <defs>
              <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#2a86ff"/><stop offset="50%" stop-color="#2ad0ff"/><stop offset="100%" stop-color="#7cf9ff"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="center">
            <div class="pct" id="weekPct">0%</div>
            <div class="cap">Fortschritt</div>
          </div>
        </div>
        <div class="weekRight">
          <div class="big">
            <span id="weekIst" title="aktuell">0</span>
            <span class="star"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2l2.7 5.7 6.3.9-4.6 4.5 1.1 6.4-5.6-3-5.6 3 1.1-6.4L3 8.6l6.3-.9L12 2z" fill="#6dd3ff"/></svg></span>
            <span style="opacity:.6">/</span>
            <span id="weekZiel" title="Ziel">0</span>
            <span class="star"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2l2.7 5.7 6.3.9-4.6 4.5 1.1 6.4-5.6-3-5.6 3 1.1-6.4L3 8.6l6.3-.9L12 2z" fill="#6dd3ff"/></svg></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Rankings nebeneinander -->
    <div class="rankRow">
      <section class="panel rankD" id="rankDPanel">
        <h2>Tagesranking</h2>
        <div class="list" id="dayList"></div>

        <!-- Tap-to-unlock Overlay -->
        <div class="tapCover" data-panel="rank">
          <div>
            <div style="font-size:15px; font-weight:900; margin-bottom:4px;">ðŸ”’ Bereich geschÃ¼tzt</div>
            <span>Zum Entsperren tippen/klicken</span>
            <div class="hint">Ranking-Passwort erforderlich</div>
          </div>
        </div>
      </section>

      <section class="panel rankW" id="rankWPanel">
        <h2>Wochenranking</h2>
        <div class="list" id="weekList"></div>

        <!-- Tap-to-unlock Overlay -->
        <div class="tapCover" data-panel="rank">
          <div>
            <div style="font-size:15px; font-weight:900; margin-bottom:4px;">ðŸ”’ Bereich geschÃ¼tzt</div>
            <span>Zum Entsperren tippen/klicken</span>
            <div class="hint">Ranking-Passwort erforderlich</div>
          </div>
        </div>
      </section>
    </div>

  </div>
</div>

<!-- Modal: Seiten-Passwort -->
<div class="modalBackdrop" id="siteModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="siteModalTitle">
    <h3 id="siteModalTitle">Zugang geschÃ¼tzt</h3>
    <input type="password" id="sitePwdInput" placeholder="Seiten-Passwort" autocomplete="current-password"/>
    <div class="rowBtns">
      <button id="siteOkBtn">Anmelden</button>
    </div>
    <div style="color:var(--muted); font-size:12px">Wird fÃ¼r 24&nbsp;Stunden gemerkt.</div>
  </div>
</div>

<!-- Modal: Ranking-Passwort -->
<div class="modalBackdrop" id="rankModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rankModalTitle">
    <h3 id="rankModalTitle">Ranking entsperren</h3>
    <input type="password" id="rankPwdInput" placeholder="Ranking-Passwort" autocomplete="current-password"/>
    <div class="rowBtns">
      <button id="rankCancelBtn">Abbrechen</button>
      <button id="rankOkBtn">Entsperren</button>
    </div>
    <div style="color:var(--muted); font-size:12px">Wird fÃ¼r 24&nbsp;Stunden gemerkt.</div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyZUilkl_0BGNzUu3UsJ8U1H75ZCWpcbF08UTYJKmbxLHQZH8T23OCOaUiykZ5Ft41ZGA/exec"; // <- hier deine Apps-Script-Web-App URL eintragen
const REFRESH_MS = 20000;

function saveWithTTL(key, val, ttlMs){ localStorage.setItem(key, JSON.stringify({v:val, t:Date.now(), ttl:ttlMs})); }
function loadWithTTL(key){
  const raw = localStorage.getItem(key); if(!raw) return null;
  try{ const o = JSON.parse(raw); if(Date.now()-o.t > (o.ttl||0)) { localStorage.removeItem(key); return null; } return o.v; }
  catch(_){ localStorage.removeItem(key); return null; }
}

/* ---------- SITE AUTH (Rhodenburg) ---------- */
(function siteAuth(){
  const DAY_MS = 24*60*60*1000;
  const SITE_PWD = "Rhodenburg";
  const modal  = document.getElementById("siteModal");
  const inp    = document.getElementById("sitePwdInput");
  const btnOk  = document.getElementById("siteOkBtn");

  function open(){ modal.style.display = "grid"; setTimeout(()=> inp.focus(), 30); }
  function close(){ modal.style.display = "none"; }

  const ok = loadWithTTL("rhodenburg_site") === true;
  if (!ok) open();

  btnOk.addEventListener("click", ()=>{
    if ((inp.value||"").trim() === SITE_PWD){
      saveWithTTL("rhodenburg_site", true, DAY_MS);
      close();
    } else { alert("Falsches Passwort."); inp.focus(); }
  });
  inp.addEventListener("keydown", e => { if(e.key === "Enter") btnOk.click(); });
})();

/* ---------- RANK AUTH (tap â†’ modal) ---------- */
(function rankAuthTapModal(){
  const DAY_MS = 24*60*60*1000;
  const RANK_PWD = "Rhodenburg1234";

  const covers = Array.from(document.querySelectorAll('.tapCover[data-panel="rank"]'));
  const modal  = document.getElementById("rankModal");
  const inp    = document.getElementById("rankPwdInput");
  const btnOk  = document.getElementById("rankOkBtn");
  const btnNo  = document.getElementById("rankCancelBtn");

  function isUnlocked(){ return loadWithTTL("rhodenburg_rank") === true; }
  function hideCovers(){ covers.forEach(c => c.style.display = "none"); }
  function showCovers(){ covers.forEach(c => c.style.display = "grid"); }

  function openModal(){
    modal.style.display = "grid";
    inp.value = "";
    setTimeout(()=> inp.focus(), 30);
  }
  function closeModal(){ modal.style.display = "none"; }

  if (isUnlocked()) hideCovers(); else showCovers();
  covers.forEach(c => c.addEventListener("click", openModal));

  btnOk.addEventListener("click", ()=>{
    const v = (inp.value||"").trim();
    if (v === RANK_PWD){
      saveWithTTL("rhodenburg_rank", true, DAY_MS);
      hideCovers(); closeModal();
    } else { alert("Falsches Passwort."); inp.focus(); }
  });
  btnNo && btnNo.addEventListener("click", closeModal);
  inp.addEventListener("keydown", e => { if(e.key === "Enter") btnOk.click(); });
  modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });
})();

/* ---------- DATA & RENDER ---------- */
const $ = sel => document.querySelector(sel);
const dayFill = $("#dayFill");
const weekArc = $("#weekArc");

function setUpdated(ts){
  try{
    const d = new Date(ts);
    $("#updatedAt").textContent = d.toLocaleString('de-DE');
  }catch(_){ $("#updatedAt").textContent = ts || "â€”"; }
}

function fmtStars(n){ return Number(n||0).toLocaleString('de-DE'); }

function countTo(el, target, ms=500){
  const start = Number(el.textContent.replace(/\D/g,""))||0;
  const t0 = performance.now();
  function frame(t){
    const p = Math.min(1, (t - t0)/ms);
    const val = Math.round(start + (target - start)*p);
    el.textContent = fmtStars(val);
    if (p<1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function setDay(goal, ist){
  const pct = goal>0 ? Math.max(0, Math.min(100, (ist/goal)*100)) : 0;
  dayFill.style.width = pct.toFixed(2) + "%";
  $("#dayGoal").textContent = fmtStars(goal);
  countTo($("#dayIst"), Math.round(ist));
  $("#dayZiel").textContent = fmtStars(goal);
}

function setWeek(goal, ist){
  const circ = 2*Math.PI*42; // dasharray 264 in SVG
  const pct = goal>0 ? Math.max(0, Math.min(100, (ist/goal)*100)) : 0;
  const off = circ * (1 - pct/100);
  weekArc.setAttribute("stroke-dasharray", String(circ));
  weekArc.setAttribute("stroke-dashoffset", String(off));
  $("#weekPct").textContent = Math.round(pct) + "%";
  countTo($("#weekIst"), Math.round(ist));
  $("#weekZiel").textContent = fmtStars(goal);
}

function makeItem(i, name, stars){
  const badgeClass = i===1?'gold': i===2?'silver': i===3?'bronze':'';
  const div = document.createElement('div');
  div.className = 'item';
  div.innerHTML = `
    <div class="rankNum"><div class="badge ${badgeClass}"></div><div>#${i}</div></div>
    <div class="name">${name}</div>
    <div class="score">${fmtStars(stars)} <span class="star"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2l2.7 5.7 6.3.9-4.6 4.5 1.1 6.4-5.6-3-5.6 3 1.1-6.4L3 8.6l6.3-.9L12 2z" fill="#6dd3ff"/></svg></span></div>`;
  return div;
}

function renderRanking(listEl, arr){
  listEl.innerHTML = "";
  arr.slice(0,20).forEach((r,idx)=> listEl.appendChild(makeItem(r.rank ?? (idx+1), r.name, r.stars)));
}

let state = { data:null, currentChallengeIndex:0 };

async function fetchData(){
  const res = await fetch(API_URL, {cache:'no-store'});
  const data = await res.json();
  return data;
}

function populateChallengeSelect(challenges){
  const sel = $("#challengeSelect");
  sel.innerHTML = "";
  challenges.forEach((c,i)=>{
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = (c.title || `Challenge ${i+1}`);
    sel.appendChild(opt);
  });
  sel.value = String(state.currentChallengeIndex || 0);
}

function applyData(data){
  setUpdated(data.updatedAt || new Date().toISOString());

  // Rankings
  renderRanking($("#dayList"),  data.day  || []);
  renderRanking($("#weekList"), data.week || []);

  // Challenges
  const ch = data.challenges || [];
  if (ch.length){
    populateChallengeSelect(ch);
    const idx = Math.min(state.currentChallengeIndex || 0, ch.length-1);
    const cur = ch[idx];

    // Day
    const dGoal = Math.round(cur.day?.ziel || 0);
    const dIst  = Math.round(cur.day?.ist  || 0);
    setDay(dGoal, dIst);

    // Week
    const wGoal = Math.round(cur.week?.ziel || 0);
    const wIst  = Math.round(cur.week?.ist  || 0);
    setWeek(wGoal, wIst);
  }
}

$("#challengeSelect").addEventListener("change", (e)=>{
  state.currentChallengeIndex = parseInt(e.target.value,10) || 0;
  if (state.data) applyData(state.data);
});

async function refresh(){
  try{
    const d = await fetchData();
    state.data = d;
    applyData(d);
  }catch(e){
    console.error("Fetch/Render error", e);
  }finally{
    setTimeout(refresh, REFRESH_MS);
  }
}

// Start
refresh();
</script>
</body>
</html>
