<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>Ranking</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    body{
      margin:0;background:radial-gradient(circle at top,#0a0f1e,#000);color:#fff;
      font-family: "Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;display:flex;justify-content:center;align-items:center;
    }
    .container{display:flex;flex-direction:column;gap:30px;width:95%;max-width:600px;text-align:center;}
    .block{background:rgba(20,25,40,.95);border-radius:16px;padding:15px;box-shadow:0 0 15px rgba(0,0,0,.6);position:relative;overflow:hidden}
    .block.tag{border:2px solid #3af;box-shadow:0 0 15px #3af,0 0 30px #08f inset}
    .block h2{margin:0 0 10px;font-size:1.4rem;letter-spacing:1px;text-transform:uppercase;text-shadow:0 0 8px rgba(255,255,255,.5)}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    td{padding:6px 8px;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative}
    td.rank{width:40px;font-weight:700;text-align:center}
    td.je{text-align:right;font-variant-numeric:tabular-nums}
    .gold{color:gold}.silver{color:silver}.bronze{color:#cd7f32}

    /* Krone sitzt auf der Zahl 1 (Rank-Zelle), leicht schrÃ¤g */
    .crown{
      position:absolute;
      top:-8px;               /* feinjustiert fÃ¼r â€žauf der 1 sitzenâ€œ */
      left:50%;
      transform:translate(-50%,-60%) rotate(-18deg);
      transform-origin:bottom center;
      font-size:1.1rem;
      text-shadow:0 0 6px gold,0 0 12px orange;
      pointer-events:none;
    }

    .error{opacity:.8;font-size:.9rem;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="block tag">
      <h2>Tag</h2>
      <table id="tag"></table>
      <div class="error" id="err-tag"></div>
    </div>
    <div class="block">
      <h2>Woche</h2>
      <table id="woche"></table>
      <div class="error" id="err-woche"></div>
    </div>
    <div class="block">
      <h2>Monat</h2>
      <table id="monat"></table>
      <div class="error" id="err-monat"></div>
    </div>
    <div class="block">
      <h2>Jahr</h2>
      <table id="jahr"></table>
      <div class="error" id="err-jahr"></div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx0gxZelxsLaQJnA1nLfyp9k_PiAlptZsPsRrsVDGRwS_yHjCMsDM1ZKA3GBEwdCYi9/exec";

    // Merker fÃ¼r den aktuellen Tag-Platz1 (Name), damit wir nur bei Wechsel animieren
    let prevDayTopName = null;

    function formatJEFromAPI(v){
      const num = parseFloat(String(v).replace(",", "."));
      if (isNaN(num)) return "";
      return num.toLocaleString("de-DE", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + " JE";
    }

    async function loadData(){
      try{
        const res = await fetch(API_URL + "?_ts=" + Date.now(), {cache:"no-store"});
        const data = await res.json();
        // Render
        renderBlock("tag",   data.day,   "err-tag",   true);
        renderBlock("woche", data.week,  "err-woche");
        renderBlock("monat", data.month, "err-monat");
        renderBlock("jahr",  data.year,  "err-jahr");
      }catch(e){
        console.error(e);
        showErr("err-tag","API nicht erreichbar");
        showErr("err-woche","");
        showErr("err-monat","");
        showErr("err-jahr","");
      }
    }

    function showErr(errId,msg){
      const el = document.getElementById(errId);
      if(!el) return;
      el.textContent = msg || "";
    }

    function renderBlock(tableId, arr, errId, isDay=false){
      const table = document.getElementById(tableId);
      if(!table) return;

      table.innerHTML = "";
      showErr(errId,"");

      const items = Array.isArray(arr) ? arr.slice(0,5) : [];
      if(items.length === 0){
        showErr(errId,"Keine Daten");
      }

      items.forEach((row, i) => {
        const tr = document.createElement("tr");

        const tdRank = document.createElement("td");
        tdRank.className = "rank";
        tdRank.textContent = (i+1);
        if(i===0) tdRank.classList.add("gold");
        else if(i===1) tdRank.classList.add("silver");
        else if(i===2) tdRank.classList.add("bronze");

        const tdName = document.createElement("td");
        tdName.textContent = row?.name ?? "";

        const tdJE = document.createElement("td");
        tdJE.className = "je";
        tdJE.textContent = formatJEFromAPI(row?.je);

        tr.appendChild(tdRank);
        tr.appendChild(tdName);
        tr.appendChild(tdJE);
        table.appendChild(tr);
      });

      // Einblendung des Blocks
      gsap.fromTo(table,{opacity:0,y:10},{opacity:1,y:0,duration:.8,ease:"power2.out"});

      // KRONEN-LOGIK â€“ nur fÃ¼r "Tag"
      if(isDay){
        const topName = items?.[0]?.name || null;

        const rankCell = table.querySelector("tr:first-child td.rank");
        if(rankCell){
          // vorhandene Krone im Tag-Block finden (falls vorhanden)
          const existing = rankCell.querySelector(".crown");

          if(prevDayTopName === null){
            // Erstes Rendering: Krone sichtbar, aber keine â€žFallâ€œ-Animation
            ensureCrown(rankCell);
          }else if(topName !== prevDayTopName){
            // â†’ Ereignis A: Neuer Platz 1
            // 1) alte Krone (falls vorhanden) fallen lassen
            if(existing){ dropCrown(existing); }
            // 2) neue Krone an die neue â€ž1â€œ fliegen lassen
            const newCrown = ensureCrown(rankCell);
            gsap.fromTo(newCrown,
              {y:-40, opacity:0, rotate:-50},
              {y:0, opacity:1, rotate:-18, duration:0.9, ease:"bounce.out"}
            );
          }else{
            // Kein Wechsel: Krone bleibt ruhig (sicherstellen, dass sie da ist)
            if(!existing) ensureCrown(rankCell);
          }
        }

        // Merker aktualisieren
        prevDayTopName = topName;
      }
    }

    // Setzt (oder holt) die Krone in die Rank-Zelle von Platz 1
    function ensureCrown(rankCell){
      let crown = rankCell.querySelector(".crown");
      if(!crown){
        crown = document.createElement("span");
        crown.className = "crown";
        crown.textContent = "ðŸ‘‘";
        rankCell.style.position = "relative"; // Anker
        rankCell.appendChild(crown);
      }
      return crown;
    }

    // LÃ¤sst die vorhandene Krone an Ort und Stelle nach unten fallen + verblassen
    function dropCrown(crownEl){
      // Klon in Fixed-Position an exakt gleicher Bildschirm-Position
      const rect = crownEl.getBoundingClientRect();
      const clone = crownEl.cloneNode(true);
      Object.assign(clone.style, {
        position: "fixed",
        left: rect.left + "px",
        top: rect.top + "px",
        margin: 0,
        transform: crownEl.style.transform || "translate(-50%,-60%) rotate(-18deg)",
        zIndex: 9999
      });
      document.body.appendChild(clone);

      // Original sofort entfernen (damit keine doppelte Krone hÃ¤ngt)
      crownEl.remove();

      // Fall + Aufprall + Verblassen
      gsap.to(clone, {
        y: 120,
        rotate: 15,
        ease: "bounce.out",
        duration: 1.0,
        onComplete: () => {
          gsap.to(clone, {opacity:0, duration:0.4, onComplete:()=> clone.remove()});
        }
      });
    }

    loadData();
    setInterval(loadData, 15000); // Auto-Refresh
  </script>
</body>
</html>
